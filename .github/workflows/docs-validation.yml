name: Documentation Validation

on:
  pull_request:
    paths:
      - '**.md'
      - '**.mmd'
      - 'docs/**'
  push:
    branches:
      - main
    paths:
      - '**.md'
      - '**.mmd'
      - 'docs/**'

jobs:
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: articulate/actions-markdownlint@v1
        with:
          config: .markdownlint.json
          files: '**/*.md'
          ignore: node_modules
        continue-on-error: true

  link-check:
    name: Link Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.markdown-link-check.json'
        continue-on-error: true

  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check spelling
        uses: rojopolis/spellcheck-github-actions@0.36.0
        with:
          config_path: .spellcheck.yml
        continue-on-error: true

  mermaid-validation:
    name: Mermaid Diagram Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Validate Mermaid diagrams
        run: |
          echo "Validating .mmd files..."
          find . -name "*.mmd" -type f | while read file; do
            echo "Validating $file"
            mmdc -i "$file" -o /tmp/test.png || echo "Error in $file"
          done
        continue-on-error: true

  adr-format-check:
    name: ADR Format Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check ADR format
        run: |
          echo "Checking ADR format compliance..."
          for adr in docs/decisions/[0-9]*.md; do
            if [ -f "$adr" ]; then
              echo "Checking $adr"

              # Check for required sections
              if ! grep -q "## Context and Problem Statement" "$adr" && \
                 ! grep -q "## Context" "$adr"; then
                echo "❌ Missing Context section in $adr"
              fi

              if ! grep -q "## Decision Outcome" "$adr" && \
                 ! grep -q "## Decision" "$adr"; then
                echo "❌ Missing Decision section in $adr"
              fi

              if ! grep -q "## Consequences" "$adr" || \
                 ! grep -q "Consequences" "$adr"; then
                echo "⚠️  Missing Consequences section in $adr"
              fi

              echo "✅ Format check complete for $adr"
            fi
          done
        continue-on-error: true

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [markdown-lint, link-check, spell-check, mermaid-validation, adr-format-check]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Documentation Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All validation checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the individual job logs for details." >> $GITHUB_STEP_SUMMARY
